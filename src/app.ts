require('dotenv').config()
import {downloadFile, fetchData, writeFile} from './util-functions';
const csv = require('csvtojson')

const appData: AppData = {
  serverList: [],
  vulnList: [],
  ruleList: [],
};


const fetchServers = async () => {
  const serversData = await fetchData(process.env.URI_SERVERS, {method: 'GET', headers: {'Authorization': 'Aa123456!'}})
  appData.serverList = await serversData.json();
  console.log(appData.serverList)
}
const fetchVulns = async () => {
  const vulnsData = await fetchData(process.env.URI_VULNERABILITIES, {method: 'POST', body: JSON.stringify({startId: 1, amount: 10})})
  appData.vulnList = await vulnsData.json();
  console.log(appData.vulnList)
}
const fetchRules = async () => {
  await downloadFile(process.env.URI_RULES, {method: 'GET'}, process.env.CSV_RULES_FILE_PATH)
  const jsonInstance = csv()
  appData.ruleList = await jsonInstance.fromFile(process.env.CSV_RULES_FILE_PATH)
  console.log(appData.ruleList);
}

const fetchAllData = async () => {
    await fetchServers()
    await fetchVulns()
    await fetchRules()
}
const mainFunction = async () => {
  console.log('interval running')
  const results = []
  try {
    await fetchAllData()
    // calculate results
    appData.serverList.forEach(s => {
      appData.vulnList.forEach(v => {
        
        let trueRulesCounter = 0;
        appData.ruleList.forEach((r) => {
          let asset: Server | Vuln | null;
 
          switch (r.type.toLowerCase()) {
            case 'server':
              asset = s
              break;
            case 'vulnerability':
              asset = v
              break;
          }

          // Check asset 
          switch (r.operator.toLowerCase()) {
            case 'eq':
              if (asset[r.parameter] === r.value) trueRulesCounter++;
              break;
            case 'gt':
              if (parseInt(asset[r.parameter]) > parseInt(r.value)) trueRulesCounter++;
              break;
            case 'lt':
              if (parseInt(asset[r.parameter]) < parseInt(r.value)) trueRulesCounter++;
              break;
          }

          if (trueRulesCounter === appData.ruleList.length) {
            // All rules is true -> vulnerable server
            // console.log('vulnerable asset found')
            results.push(`vulnerability ${v.name} with risk ${v.risk} discovered on ${s.hostname} ${s.ip}`)
            console.log(results.length)
          }
        })
      })
    })

  } catch (error) {
    console.log(error)
  } finally {
    await writeFile(results, process.env.DETECTIONS_FILE_PATH)
    console.log('interval end')
  }
}
(async () => {
  console.log('starting...')
  mainFunction()
  // setInterval(mainFunction, parseInt(process.env.INTERVAL_SECONDS))
})()


interface AppData {
  serverList: Server[],
  vulnList: Vuln[],
  ruleList: Rule[],
  // serverMap: {id: string, value: {}},
  // vulnMap: {id: string, value: {}},
}

// { id: 6138450, hostname: 'server-36973', ip: '133.82.215.31', os: 'CentOS', osVersion: '3.1'},
interface Server {
  id: number,
  hostname: string,
  ip: string,
  os: string,
  osVersion: string,
}

// { id: 11, name: 'CVE-9388-5443', risk: 5.2, affects: 'Ubuntu_8.7' }
interface Vuln {
  id: number,
  name: string,
  risk: number,
  affects?: string,
}

// { type: 'server', parameter: 'os', operator: 'eq', value: 'CentOS' },
interface Rule {
  type: string,
  parameter: string,
  operator: string,
  value: string,
}




// {
//   id: 6138450,
//   hostname: 'server-36973',
//   ip: '133.82.215.31',
//   os: 'CentOS',
//   osVersion: '3.1'
// },
// {
//   id: 6976807,
//   hostname: 'server-19049',
//   ip: '92.26.49.132',
//   os: 'Mac',
//   osVersion: '1.8'
// },
// ... 9900 more items
// ]
// [
// { id: 1, name: 'CVE-8036-7124', risk: 3.46, affects: 'CentOS_9.5' },
// { id: 2, name: 'CVE-1491-2348', risk: 6.7, affects: 'Ubuntu_2.1' },
// { id: 3, name: 'CVE-3549-1874', risk: 1.25, affects: 'CentOS_7.2' },
// { id: 4, name: 'CVE-1633-5308', risk: 2.75, affects: 'Windows_5.1' },
// { id: 5, name: 'CVE-5046-6247', risk: 1.01, affects: 'CentOS_6.7' },
// { id: 6, name: 'CVE-5231-1752', risk: 7.82, affects: 'CentOS_7.1' },
// { id: 7, name: 'CVE-6954-5480', risk: 1.34, affects: 'CentOS_5.1' },
// { id: 8, name: 'CVE-2805-3856', risk: 1.66, affects: 'CentOS_5.8' },
// { id: 9, name: 'CVE-9008-8571', risk: 6.49, affects: 'CentOS_5.8' },
// { id: 10, name: 'CVE-6943-6543', risk: 9.63 },
// { id: 11, name: 'CVE-9388-5443', risk: 5.2, affects: 'Ubuntu_8.7' }
// ]
// [
// { type: 'server', parameter: 'os', operator: 'eq', value: 'CentOS' },
// {
//   type: 'server',
//   parameter: 'osVersion',
//   operator: 'lt',
//   value: '9'
// },
// {
//   type: 'vulnerability',
//   parameter: 'risk',
//   operator: 'gt',
//   value: '7.5'
// }
// ]